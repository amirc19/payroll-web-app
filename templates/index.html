<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Payroll Summary Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { background: #4a5568; color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .main-content { padding: 30px; }
        .upload-section { background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 20px; }
        .file-input-wrapper { display: inline-block; position: relative; background: #4a5568; color: white; padding: 12px 30px; border-radius: 5px; cursor: pointer; margin: 10px; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .process-btn { background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 1.1rem; cursor: pointer; margin: 20px 0; }
        .process-btn:disabled { background: #ccc; cursor: not-allowed; }
        .file-list { margin: 20px 0; text-align: left; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #ddd; margin-bottom: 5px; border-radius: 5px; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .status-message { padding: 15px; margin: 20px 0; border-radius: 5px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-info { background: #d1ecf1; color: #0c5460; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .station-section { margin: 30px 0; border: 2px solid #4a5568; border-radius: 10px; overflow: hidden; }
        .station-header { background: #4a5568; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .station-content { padding: 20px; background: white; }
        .table-wrapper { width: 100%; overflow-x: auto; border: 2px solid #4a5568; border-radius: 5px; margin: 20px 0; }
        table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
        th { background: #4a5568; color: white; font-weight: bold; }
        .employee-name { text-align: left; font-weight: bold; background: #f8f9fa; position: sticky; left: 0; z-index: 10; width: 200px; }
        .total-column { background: #fff700; font-weight: bold; color: #000; }
        .date-header { background: #6c757d; color: white; }
        .download-section { text-align: center; padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #4a5568; }
        .modal-buttons { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; }
        .btn-save, .btn-cancel { padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 1rem; border: none; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #6c757d; color: white; }
        .form-group { margin: 20px 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #495057; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1rem; }
        .toggle-container { display: flex; align-items: center; margin: 20px 0; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; margin-right: 15px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #4a5568; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .dynamic-fields { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #4a5568; }
        .bonus-tier { border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 10px; background: white; }
        .onboarding-progress { width: 100%; background-color: #e0e0e0; border-radius: 10px; margin: 10px 0; height: 8px; }
        .onboarding-progress-bar { height: 8px; background-color: #28a745; border-radius: 10px; transition: width 0.3s ease; }
	.pay-column { background: #28a745; color: white; font-weight: bold; }
	.total-payroll { background: #dc3545; color: white; font-weight: bold; font-size: 1.2rem; }
	
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Weekly Payroll Summary Generator</h1>
            <p>Upload XLS files and generate payroll summaries by station</p>
        </div>

        <div class="main-content">
            <div class="upload-section" style="margin-bottom: 30px;">
                <h3>Driver Management</h3>
                <p>Manage existing driver payment information</p>
                <div style="text-align: center; margin: 20px 0;">
                    <button onclick="showAddDriverModal()" class="process-btn" style="background: #17a2b8; margin-right: 10px;">Add New Driver</button>
                    <button onclick="displayDriverManagement()" class="process-btn" style="background: #6c757d;">View All Drivers</button>
                </div>
                <div id="driverManagementResults" style="display: none; margin-top: 20px;">
                    <div id="driverManagementTable"></div>
                </div>
            </div>

            <div class="upload-section">
                <h3>Upload Daily Service Worksheets</h3>
                <p>Select your XLS files from multiple stations</p>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" multiple accept=".xls,.xlsx" onchange="handleFiles(this.files)" />
                    Choose Files
                </div>
                <div id="fileList" class="file-list"></div>
            </div>

            <div style="text-align: center;">
                <button onclick="processFiles()" id="processBtn" class="process-btn" disabled>Generate Station Payroll Summaries</button>
                <button onclick="calculatePay()" id="calculatePayBtn" class="process-btn" style="background: #17a2b8; display: none; margin-left: 10px;">Calculate Pay</button>
            </div>

	   <div id="exportSection" style="display: none; text-align: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
    		<h4 style="margin-bottom: 15px; color: #495057;">Export Data for Accounting Software</h4>
    		<div style="background: #e1f5fe; border: 1px solid #81d4fa; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
        		<small><strong>Note:</strong> All exports will include any edits you've made to the data in the tables above.</small>
    		</div>
    		<div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        		<button onclick="exportAllStationsToExcelWithEdits()" class="process-btn" style="background: #28a745; font-size: 1rem; padding: 12px 20px;">Export All Stations (Excel)</button>
        		<button onclick="exportPayrollSummaryToExcel()" class="process-btn" style="background: #17a2b8; font-size: 1rem; padding: 12px 20px;">Export Payroll Summary (Excel)</button>
        		<button onclick="exportPayrollTimeTableWithEdits()" class="process-btn" style="background: #6f42c1; font-size: 1rem; padding: 12px 20px; color: white;">Make Payroll Time Table</button>
    		</div>
		</div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Processing files...</p>
            </div>

            <div id="statusMessage"></div>
            
            <div id="resultsSection" style="display: none; margin-top: 30px;">
                <h3>Station Payroll Summaries</h3>
                <div id="stationResults"></div>
            </div>
        </div>
    </div>

    <div id="driverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Driver Configuration</h2>
            </div>
            
            <div id="driverNameDisplay" style="background: #e9ecef; padding: 15px; border-radius: 5px; text-align: center; margin: 20px 0; font-size: 1.2rem; font-weight: bold; color: #495057;"></div>
            
            <form id="driverForm">
                <div class="form-group">
                    <label for="paymentMethod">How is driver paid?</label>
                    <select id="paymentMethod" onchange="updateDynamicFields(this.value)" required>
                        <option value="">-- Select Payment Method --</option>
                        <option value="salary">Salary</option>
                        <option value="hourly">Hourly</option>
                        <option value="daily_rate">Daily Rate</option>
                        <option value="stop_rate">Stop Rate</option>
                        <option value="daily_stop">Daily Rate + Stop Rate</option>
                        <option value="daily_stop_bonus">Daily Rate + Stop Bonus</option>
                        <option value="daily_stop_threshold">Daily Rate + Stop Rate over threshold</option>
                        <option value="hybrid">Hybrid (Daily Rate + Stop Pay + Bonus)</option>
                    </select>
                </div>
                
                <div class="toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="attendanceBonus" onchange="toggleAttendanceBonus()">
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="attendanceBonus" style="font-weight: bold; color: #495057; cursor: pointer;">Attendance bonus applies (optional)</label>
                </div>
                
                <div id="attendanceBonusFields" class="dynamic-fields" style="display: none;">
                    <div class="form-group">
                        <label for="attendanceDays">How many days do they need to attend? (1-7)</label>
                        <select id="attendanceDays" required>
                            <option value="">-- Select Days --</option>
                            <option value="1">1 day</option>
                            <option value="2">2 days</option>
                            <option value="3">3 days</option>
                            <option value="4">4 days</option>
                            <option value="5">5 days</option>
                            <option value="6">6 days</option>
                            <option value="7">7 days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bonusAmount">Bonus amount ($)</label>
                        <input type="number" id="bonusAmount" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div id="dynamicFields" class="dynamic-fields" style="display: none;"></div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeDriverModal()">Cancel</button>
                    <button type="button" class="btn-save" onclick="saveDriverData()">Save & Continue</button>
                </div>
            </form>
        </div>
    </div>

    <script>
 let files = [];
let driverData = new Map();
let currentEditingDriver = null;
let lastProcessedResults = null;
let currentOnboardingDrivers = [];
let currentOnboardingIndex = 0;

window.onload = function() {
    loadDriverData();
    updateProcessButton();
};

async function loadDriverData() {
    try {
        const response = await fetch('/api/drivers');
        if (response.ok) {
            const data = await response.json();
            driverData = new Map(Object.entries(data));
        }
    } catch (error) {
        console.error('Error loading driver data:', error);
    }
}

function handleFiles(fileList) {
    if (!fileList || fileList.length === 0) return;
    
    const newFiles = Array.from(fileList).filter(file => {
        return file.name.endsWith('.xls') || file.name.endsWith('.xlsx');
    });
    
    files.push(...newFiles);
    updateFileList();
    updateProcessButton();
    showStatus(`${newFiles.length} files added successfully`, 'success');
}

function updateFileList() {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';

    if (files.length === 0) {
        fileList.innerHTML = '<p style="color: #666; font-style: italic;">No files selected</p>';
        return;
    }

    files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span><strong>${file.name}</strong> (${(file.size / 1024).toFixed(1)} KB)</span>
            <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
        `;
        fileList.appendChild(fileItem);
    });
    
    const summary = document.createElement('div');
    summary.style.cssText = 'margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px; text-align: center;';
    summary.innerHTML = `<strong>${files.length} file(s) ready to process</strong>`;
    fileList.appendChild(summary);
}

function removeFile(index) {
    files.splice(index, 1);
    updateFileList();
    updateProcessButton();
}

function updateProcessButton() {
    const processBtn = document.getElementById('processBtn');
    const isDisabled = files.length === 0;
    processBtn.disabled = isDisabled;
    processBtn.style.backgroundColor = isDisabled ? '#ccc' : '#28a745';
}

async function processFiles() {
    if (files.length === 0) {
        showStatus('Please select files first', 'error');
        return;
    }
    
    showStatus('Processing files and sorting by station...', 'info');
    document.getElementById('loading').style.display = 'block';
    
    try {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('files', file);
        });
        
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server error: ${response.status} - ${errorText}`);
        }
        
        const stationResults = await response.json();
        lastProcessedResults = stationResults;
        displayAllStations(stationResults);
        
        document.getElementById('calculatePayBtn').style.display = 'inline-block';
        
        const totalStations = Object.keys(stationResults).length;
        showStatus(`Successfully processed ${files.length} files from ${totalStations} stations.`, 'success');
        
    } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

async function calculatePay() {
    if (!lastProcessedResults) {
        showStatus('No payroll data available. Please generate summaries first.', 'error');
        return;
    }
    
    let allDrivers = [];
    for (let stationCode in lastProcessedResults) {
        for (let driverRow of lastProcessedResults[stationCode].weeklyData) {
            if (!allDrivers.includes(driverRow.driver)) {
                allDrivers.push(driverRow.driver);
            }
        }
    }
    
    let driversNeedingConfig = allDrivers.filter(driver => !driverData.has(driver));
    
    if (driversNeedingConfig.length > 0) {
        showStatus(`Found ${driversNeedingConfig.length} drivers needing payment configuration`, 'info');
        startDriverOnboarding(driversNeedingConfig);
    } else {
        performPayCalculation();
    }
}

function startDriverOnboarding(driversToOnboard) {
    currentOnboardingDrivers = driversToOnboard;
    currentOnboardingIndex = 0;
    showNextDriverOnboarding();
}

function showNextDriverOnboarding() {
    if (currentOnboardingIndex >= currentOnboardingDrivers.length) {
        completeDriverOnboarding();
        return;
    }
    
    const driverName = currentOnboardingDrivers[currentOnboardingIndex];
    showDriverOnboardingModal(driverName);
}

function showDriverOnboardingModal(driverName) {
    currentEditingDriver = null;
    const progressPercent = ((currentOnboardingIndex + 1) / currentOnboardingDrivers.length) * 100;
    
    document.getElementById('driverNameDisplay').innerHTML = `
        <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #0c5460;">Driver Payment Setup</h3>
            <p style="margin: 5px 0 0 0; color: #0c5460;">Configure payment method for this driver to calculate their pay.</p>
        </div>
        <div style="font-size: 1.2rem; font-weight: bold; color: #495057;">${driverName}</div>
        <div style="font-size: 0.9rem; color: #6c757d; margin: 5px 0;">Driver ${currentOnboardingIndex + 1} of ${currentOnboardingDrivers.length}</div>
        <div class="onboarding-progress">
            <div class="onboarding-progress-bar" style="width: ${progressPercent}%;"></div>
        </div>
    `;
    
    document.getElementById('paymentMethod').value = '';
    document.getElementById('attendanceBonus').checked = false;
    document.getElementById('dynamicFields').style.display = 'none';
    document.getElementById('attendanceBonusFields').style.display = 'none';
    
    document.querySelector('.modal-header h2').textContent = 'Configure Driver Payment';
    const saveButton = document.querySelector('.btn-save');
    saveButton.textContent = currentOnboardingDrivers.length - currentOnboardingIndex > 1 ? 'Save & Next Driver' : 'Save & Calculate Pay';
    
    document.getElementById('driverModal').style.display = 'block';
}

function completeDriverOnboarding() {
    currentOnboardingDrivers = [];
    currentOnboardingIndex = 0;
    showStatus('Driver configuration completed! Calculating pay...', 'success');
    
    setTimeout(() => {
        performPayCalculation();
    }, 1000);
}


function performPayCalculation() {
    showStatus('Calculating pay for all drivers...', 'info');
    displayAllStationsWithPayCalculation(lastProcessedResults);
    document.getElementById('exportSection').style.display = 'block';
    showStatus('Pay calculation completed! Weekly pay amounts displayed in the rightmost column.', 'success');
}

function displayAllStationsWithPay(stationResults) {
    displayAllStations(stationResults);
    
    const resultsDiv = document.getElementById('stationResults');
    const payNote = document.createElement('div');
    payNote.style.cssText = 'background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 20px 0; border-radius: 5px; text-align: center;';
    payNote.innerHTML = `
        <h4 style="margin: 0 0 10px 0; color: #155724;">Pay Calculation Complete</h4>
        <p style="margin: 0; color: #155724;">All drivers have been configured. Pay calculations would be displayed here in the full version.</p>
    `;
    resultsDiv.insertBefore(payNote, resultsDiv.firstChild);
}

function displayAllStations(stationResults) {
    const stationResultsDiv = document.getElementById('stationResults');
    stationResultsDiv.innerHTML = '';
    
    const sortedStations = Object.keys(stationResults).sort();
    
    sortedStations.forEach(stationCode => {
        const stationData = stationResults[stationCode];
        
        const stationSection = document.createElement('div');
        stationSection.className = 'station-section';
        
        const stationHeader = document.createElement('div');
        stationHeader.className = 'station-header';
        stationHeader.innerHTML = `
            <div style="font-size: 1.3rem; font-weight: bold;">${stationCode}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">${stationData.files.length} files | ${stationData.weeklyData.length} drivers | ${stationData.dates[0]} to ${stationData.dates[stationData.dates.length - 1]}</div>
        `;
        
        const stationContent = document.createElement('div');
        stationContent.className = 'station-content';
        
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';
        
        const table = document.createElement('table');
        table.innerHTML = createTableHTML(stationData.dates, stationData.weeklyData);
        
        tableWrapper.appendChild(table);
        stationContent.appendChild(tableWrapper);
        
        const downloadSection = document.createElement('div');
        downloadSection.className = 'download-section';
        downloadSection.innerHTML = `
            <button onclick="downloadStation('${stationCode}', ${JSON.stringify(stationData).replace(/"/g, '&quot;')})" style="background: #17a2b8; color: white; border: none; padding: 15px 30px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 1.1rem;">
                Download ${stationCode} Payroll Summary
            </button>
        `;
        
        stationSection.appendChild(stationHeader);
        stationSection.appendChild(stationContent);
        stationSection.appendChild(downloadSection);
        
        stationResultsDiv.appendChild(stationSection);
    });
    
    document.getElementById('resultsSection').style.display = 'block';
}

function createTableHTML(dates, weeklyData) {
    let headerHTML = `
        <thead>
            <tr>
                <th rowspan="2" class="employee-name">Employee Name</th>`;
    
    dates.forEach(date => {
        headerHTML += `<th colspan="2" class="date-header">${date}</th>`;
    });
    
    headerHTML += `
                <th rowspan="2" class="total-column">Days</th>
                <th rowspan="2" class="total-column">Total Stops</th>
                <th rowspan="2" class="total-column">Total Hours</th>
            </tr>
            <tr>`;
    
    dates.forEach(() => {
        headerHTML += `<th>Stops</th><th>Hours</th>`;
    });
    
    headerHTML += `</tr></thead><tbody>`;
    
    weeklyData.forEach(driver => {
        let totalStops = 0;
        let totalHours = 0;
        let daysWorked = 0;
        
        let rowHTML = `<tr><td class="employee-name">${driver.driver}</td>`;
        
        dates.forEach(date => {
            const dayData = driver.dates[date];
            if (dayData.totalStops > 0 || dayData.hours > 0) {
                rowHTML += `<td>${dayData.totalStops}</td><td>${dayData.hours}</td>`;
                totalStops += dayData.totalStops;
                totalHours += dayData.hours;
                daysWorked++;
            } else {
                rowHTML += '<td></td><td></td>';
            }
        });
        
        rowHTML += `<td class="total-column">${daysWorked}</td>`;
        rowHTML += `<td class="total-column">${totalStops}</td>`;
        rowHTML += `<td class="total-column">${totalHours}</td></tr>`;
        
        headerHTML += rowHTML;
    });
    
    headerHTML += '</tbody>';
    return headerHTML;
}

function downloadStation(stationCode, stationDataJson) {
    try {
        const stationData = JSON.parse(stationDataJson.replace(/&quot;/g, '"'));
        generateStationHTML(stationCode, stationData.dates, stationData.weeklyData, stationData);
    } catch (error) {
        showStatus(`Download error: ${error.message}`, 'error');
    }
}

function generateStationHTML(stationCode, dates, weeklyData, stationData) {
    let htmlContent = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${stationCode} - Weekly Payroll Summary</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.header { text-align: center; margin-bottom: 20px; }
.header h1 { color: #4a5568; margin: 0; }
.header p { margin: 5px 0; color: #666; }
table { border-collapse: collapse; width: 100%; margin: 0; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
th { background-color: #4a5568; color: white; font-weight: bold; }
.employee-name { text-align: left; font-weight: bold; background-color: #f8f9fa; }
.total-column { background-color: #FFFF00; font-weight: bold; color: #000; }
.footer { margin-top: 20px; text-align: center; font-size: 12px; color: #666; }
</style></head><body>
<div class="header">
<h1>${stationCode} - WEEKLY PAYROLL SUMMARY</h1>
<p>Week: ${dates[0]} to ${dates[dates.length - 1]}</p>
<p>Generated: ${new Date().toLocaleDateString()}</p>
</div>
<table><thead><tr><th rowspan="2">EMPLOYEE NAME</th>`;

    dates.forEach(date => {
        htmlContent += `<th colspan="2">${date}</th>`;
    });
    htmlContent += `<th colspan="3">WEEKLY TOTALS</th></tr><tr>`;
    
    dates.forEach(() => {
        htmlContent += `<th>Stops</th><th>Hours</th>`;
    });
    htmlContent += `<th>Days</th><th>Total Stops</th><th>Total Hours</th></tr></thead><tbody>`;

    weeklyData.forEach(driver => {
        let totalStops = 0, totalHours = 0, daysWorked = 0;
        htmlContent += `<tr><td class="employee-name">${driver.driver.toUpperCase()}</td>`;
        
        dates.forEach(date => {
            const dayData = driver.dates[date];
            if (dayData.totalStops > 0 || dayData.hours > 0) {
                htmlContent += `<td>${dayData.totalStops}</td><td>${dayData.hours}</td>`;
                totalStops += dayData.totalStops;
                totalHours += dayData.hours;
                daysWorked++;
            } else {
                htmlContent += `<td></td><td></td>`;
            }
        });
        
        htmlContent += `<td class="total-column">${daysWorked}</td><td class="total-column">${totalStops}</td><td class="total-column">${totalHours}</td></tr>`;
    });
    
    htmlContent += `</tbody></table>
<div class="footer"><p>Total Drivers: ${weeklyData.length} | Generated by Payroll Summary Generator</p></div></body></html>`;

    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${stationCode.replace(/\//g, '_')}_Payroll_Summary_${Date.now()}.html`;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showStatus(`${stationCode} HTML file downloaded successfully!`, 'success');
}

function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.innerHTML = message;
    statusDiv.style.display = 'block';
}

function showAddDriverModal() {
    currentEditingDriver = null;
    document.getElementById('driverNameDisplay').innerHTML = '<input type="text" id="newDriverName" placeholder="Enter driver name (Last, First)" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1.1rem; text-align: center; font-weight: bold;">';
    document.getElementById('paymentMethod').value = '';
    document.getElementById('attendanceBonus').checked = false;
    document.getElementById('dynamicFields').style.display = 'none';
    document.getElementById('attendanceBonusFields').style.display = 'none';
    document.querySelector('.modal-header h2').textContent = 'Add New Driver';
    document.getElementById('driverModal').style.display = 'block';
}

function displayDriverManagement() {
    const resultsDiv = document.getElementById('driverManagementResults');
    const tableDiv = document.getElementById('driverManagementTable');
    
    if (driverData.size === 0) {
        tableDiv.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No drivers configured yet. Click "Add New Driver" to get started.</p>';
        resultsDiv.style.display = 'block';
        return;
    }

    let tableHTML = `
        <div style="overflow-x: auto; border: 2px solid #4a5568; border-radius: 5px; width: 100%;">
            <table style="border-collapse: collapse; width: 100%; min-width: 800px;">
                <thead>
                    <tr>
                        <th style="background: #4a5568; color: white; padding: 12px; border: 1px solid #333; width: 200px;">Driver Name</th>
                        <th style="background: #4a5568; color: white; padding: 12px; border: 1px solid #333; width: 200px;">Payment Method</th>
                        <th style="background: #4a5568; color: white; padding: 12px; border: 1px solid #333; width: 150px;">Attendance Bonus</th>
                        <th style="background: #4a5568; color: white; padding: 12px; border: 1px solid #333; width: 300px;">Payment Details</th>
                        <th style="background: #4a5568; color: white; padding: 12px; border: 1px solid #333; width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    driverData.forEach((driverInfo, driverName) => {
        const safeDriverName = driverName.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const paymentMethodText = formatPaymentMethod(driverInfo.paymentMethod);
        const paymentDetails = getPaymentDetails(driverInfo);
        
        tableHTML += `
            <tr>
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; word-wrap: break-word;">${driverName}</td>
                <td style="padding: 12px; border: 1px solid #333;">${paymentMethodText}</td>
                <td style="padding: 12px; border: 1px solid #333; text-align: center;">${driverInfo.attendanceBonus ? 'Yes' : 'No'}</td>
                <td style="padding: 12px; border: 1px solid #333; font-size: 0.9rem;">${paymentDetails}</td>
                <td style="padding: 12px; border: 1px solid #333;">
                    <button onclick="editDriver('${safeDriverName}')" style="background: #ffc107; color: #000; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; margin-right: 5px; font-weight: bold;">Edit</button>
                    <button onclick="showDeleteConfirmation('${safeDriverName}')" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-weight: bold;">Delete</button>
                </td>
            </tr>
        `;
    });

    tableHTML += `
                </tbody>
            </table>
        </div>
        <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; text-align: center;">
            <strong>Total Drivers Configured: ${driverData.size}</strong>
        </div>
    `;
    
    tableDiv.innerHTML = tableHTML;
    resultsDiv.style.display = 'block';
}

function formatPaymentMethod(method) {
    const methods = {
        'salary': 'Salary',
        'hourly': 'Hourly',
        'daily_rate': 'Daily Rate',
        'stop_rate': 'Stop Rate',
        'daily_stop': 'Daily + Stop Rate',
        'daily_stop_bonus': 'Daily + Stop Bonus',
        'daily_stop_threshold': 'Daily + Stop Rate over threshold',
        'hybrid': 'Hybrid (Daily + Stop Pay + Bonus)'
    };
    return methods[method] || method;
}

function getPaymentDetails(driverInfo) {
    let details = [];
    
    if (driverInfo.salary) details.push(`Salary: ${driverInfo.salary.toLocaleString()}`);
    if (driverInfo.hourlyRate) details.push(`Hourly: ${driverInfo.hourlyRate}`);
    if (driverInfo.dailyRate) details.push(`Daily: ${driverInfo.dailyRate}`);
    if (driverInfo.stopRate) details.push(`Stop: ${driverInfo.stopRate}`);
    if (driverInfo.stopPayTrigger) details.push(`Stop Trigger: ${driverInfo.stopPayTrigger} stops`);
    if (driverInfo.stopPayRate) details.push(`Stop Pay: ${driverInfo.stopPayRate}`);
    if (driverInfo.threshold) details.push(`Threshold: ${driverInfo.threshold} stops`);
    if (driverInfo.bonusTiers && driverInfo.bonusTiers.length > 0) {
        details.push(`Bonus Tiers: ${driverInfo.bonusTiers.length}`);
    }
    if (driverInfo.attendanceBonus && driverInfo.attendanceBonusAmount) {
        details.push(`Attendance: ${driverInfo.attendanceBonusAmount} (${driverInfo.attendanceDaysRequired || 'N/A'} days)`);
    }
    
    return details.length > 0 ? details.join('<br>') : 'Basic configuration';
}

function editDriver(driverName) {
    const actualDriverName = driverName.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
    const driverInfo = driverData.get(actualDriverName);
    
    if (!driverInfo) {
        showStatus(`Driver ${actualDriverName} not found`, 'error');
        return;
    }

    currentEditingDriver = actualDriverName;
    document.getElementById('driverNameDisplay').innerHTML = `
        <div style="background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #856404;">Editing Driver</h3>
            <p style="margin: 5px 0 0 0; color: #856404;">Modify the payment configuration for this driver.</p>
        </div>
        <div style="font-size: 1.2rem; font-weight: bold; color: #495057;">${actualDriverName}</div>
    `;
    
    document.getElementById('paymentMethod').value = driverInfo.paymentMethod;
    updateDynamicFields(driverInfo.paymentMethod);
    
    document.getElementById('attendanceBonus').checked = driverInfo.attendanceBonus || false;
    toggleAttendanceBonus();

    setTimeout(() => {
        if (driverInfo.attendanceBonus) {
            const attendanceDays = document.getElementById('attendanceDays');
            const bonusAmount = document.getElementById('bonusAmount');
            if (attendanceDays && driverInfo.attendanceDaysRequired) {
                attendanceDays.value = driverInfo.attendanceDaysRequired;
            }
            if (bonusAmount && driverInfo.attendanceBonusAmount) {
                bonusAmount.value = driverInfo.attendanceBonusAmount;
            }
        }

        populatePaymentFields(driverInfo);
    }, 200);
    
    document.querySelector('.modal-header h2').textContent = 'Edit Driver Information';
    document.querySelector('.btn-save').textContent = 'Save Changes';
    document.getElementById('driverModal').style.display = 'block';
}

function populatePaymentFields(driverInfo) {
    if (driverInfo.salary) {
        const salaryAmount = document.getElementById('salaryAmount');
        if (salaryAmount) salaryAmount.value = driverInfo.salary;
    }
    if (driverInfo.hourlyRate) {
        const hourlyRate = document.getElementById('hourlyRate');
        if (hourlyRate) hourlyRate.value = driverInfo.hourlyRate;
    }
    if (driverInfo.dailyRate) {
        const dailyRate = document.getElementById('dailyRate');
        if (dailyRate) dailyRate.value = driverInfo.dailyRate;
    }
    if (driverInfo.stopRate) {
        const stopRate = document.getElementById('stopRate');
        if (stopRate) stopRate.value = driverInfo.stopRate;
    }
    if (driverInfo.stopPayTrigger) {
        const stopPayTrigger = document.getElementById('stopPayTrigger');
        if (stopPayTrigger) stopPayTrigger.value = driverInfo.stopPayTrigger;
    }
    if (driverInfo.stopPayRate) {
        const stopPayRate = document.getElementById('stopPayRate');
        if (stopPayRate) stopPayRate.value = driverInfo.stopPayRate;
    }
    if (driverInfo.threshold) {
        const threshold = document.getElementById('threshold');
        if (threshold) threshold.value = driverInfo.threshold;
    }

    if (driverInfo.bonusTiers && driverInfo.bonusTiers.length > 0) {
        const bonusTiersContainer = document.getElementById('bonusTiers');
        if (bonusTiersContainer) {
            bonusTiersContainer.innerHTML = '';
            driverInfo.bonusTiers.forEach((tier, index) => {
                const tierNumber = index + 1;
                const newTier = document.createElement('div');
                newTier.className = 'bonus-tier';
                newTier.setAttribute('data-tier', tierNumber);
                newTier.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div style="flex: 1;"><label>Stop Threshold</label><input type="number" id="stopThreshold${tierNumber}" min="0" value="${tier.threshold}" required></div>
                        <div style="flex: 1;"><label>Bonus Amount ($)</label><input type="number" id="bonusAmount${tierNumber}" step="0.01" min="0" value="${tier.bonusAmount}" required></div>
                        ${tierNumber > 1 ? `<button type="button" onclick="removeBonusTier(${tierNumber})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; align-self: end;">Remove</button>` : ''}
                    </div>
                `;
                bonusTiersContainer.appendChild(newTier);
            });
        }
    }
}

function showDeleteConfirmation(driverName) {
    const actualDriverName = driverName.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
    
    const modalHTML = `
        <div id="deleteConfirmModal" style="display: block; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
            <div style="background-color: white; margin: 10% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h2 style="color: #dc3545; margin-bottom: 20px;">Delete Driver</h2>
                <p style="font-size: 1.1rem; margin-bottom: 15px;">Are you sure you want to permanently delete:</p>
                <p style="font-weight: bold; font-size: 1.2rem; color: #333; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">"${actualDriverName}"</p>
                <p style="color: #666; margin-bottom: 30px;">This action cannot be undone!</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="confirmDeleteBtn" style="background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold;">Yes, Delete Driver</button>
                  
<button id="cancelDeleteBtn" style="background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1rem;">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        deleteDriver(actualDriverName);
        removeDeleteModal();
    });
    
    document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
        showStatus('Deletion cancelled', 'info');
        removeDeleteModal();
    });
}

async function deleteDriver(driverName) {
    if (driverData.has(driverName)) {
        driverData.delete(driverName);
        
        try {
            const response = await fetch(`/api/drivers?name=${encodeURIComponent(driverName)}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                console.warn('Failed to delete from server, removed locally only');
            }
        } catch (error) {
            console.warn('Server delete failed, removed locally only');
        }
        
        showStatus(`Driver "${driverName}" deleted successfully.`, 'success');
        
        setTimeout(() => {
            displayDriverManagement();
        }, 100);
    } else {
        showStatus('Error: Driver not found', 'error');
    }
}

function removeDeleteModal() {
    const modal = document.getElementById('deleteConfirmModal');
    if (modal) {
        modal.remove();
    }
}

function closeDriverModal() {
    let isOnboarding = currentOnboardingDrivers.length > 0 && currentOnboardingIndex < currentOnboardingDrivers.length;
    
    if (isOnboarding) {
        if (confirm(`Skip configuration for ${currentOnboardingDrivers[currentOnboardingIndex]}? You can configure them later via "Add New Driver".`)) {
            currentOnboardingIndex++;
            document.getElementById('driverModal').style.display = 'none';
            setTimeout(() => {
                showNextDriverOnboarding();
            }, 300);
        }
        return;
    }
    
    currentEditingDriver = null;
    document.querySelector('.modal-header h2').textContent = 'Driver Configuration';
    document.querySelector('.btn-save').textContent = 'Save & Continue';
    document.getElementById('driverModal').style.display = 'none';
}

function closeDriverModalSilently() {
    document.getElementById('driverModal').style.display = 'none';
    currentEditingDriver = null;
    document.querySelector('.modal-header h2').textContent = 'Driver Configuration';
    document.querySelector('.btn-save').textContent = 'Save & Continue';
}

function toggleAttendanceBonus() {
    const checkbox = document.getElementById('attendanceBonus');
    const fields = document.getElementById('attendanceBonusFields');
    fields.style.display = checkbox.checked ? 'block' : 'none';
}

function updateDynamicFields(paymentMethod) {
    const dynamicFields = document.getElementById('dynamicFields');
    dynamicFields.innerHTML = '';
    
    if (!paymentMethod) {
        dynamicFields.style.display = 'none';
        return;
    }

    dynamicFields.style.display = 'block';
    let fieldsHTML = '';

    switch (paymentMethod) {
        case 'salary':
    	    fieldsHTML = '<div class="form-group"><label>Weekly Salary ($)</label><input type="number" id="salaryAmount" step="0.01" min="0" required></div>';
            break;
        case 'hourly':
            fieldsHTML = '<div class="form-group"><label>Hourly Rate ($)</label><input type="number" id="hourlyRate" step="0.01" min="0" required></div>';
            break;
        case 'daily_rate':
            fieldsHTML = '<div class="form-group"><label>Daily Rate ($)</label><input type="number" id="dailyRate" step="0.01" min="0" required></div>';
            break;
        case 'stop_rate':
            fieldsHTML = '<div class="form-group"><label>Stop Rate ($)</label><input type="number" id="stopRate" step="0.01" min="0" required></div>';
            break;
        case 'daily_stop':
            fieldsHTML = `
                <div class="form-group"><label>Daily Rate ($)</label><input type="number" id="dailyRate" step="0.01" min="0" required></div>
                <div class="form-group"><label>Stop Rate ($)</label><input type="number" id="stopRate" step="0.01" min="0" required></div>
            `;
            break;
        case 'daily_stop_bonus':
            fieldsHTML = `
                <div class="form-group"><label>Daily Rate ($)</label><input type="number" id="dailyRate" step="0.01" min="0" required></div>
                <div style="border: 2px solid #28a745; border-radius: 5px; padding: 15px; margin: 10px 0;">
                    <h4 style="margin-bottom: 15px; color: #28a745;">Stop Bonus Tiers</h4>
                    <div id="bonusTiers">
                        <div class="bonus-tier" data-tier="1">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;"><label>Stop Threshold</label><input type="number" id="stopThreshold1" min="0" required></div>
                                <div style="flex: 1;"><label>Bonus Amount ($)</label><input type="number" id="bonusAmount1" step="0.01" min="0" required></div>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addBonusTier()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; margin-top: 10px;">+ Add Another Bonus Tier</button>
                </div>
            `;
            break;
        case 'daily_stop_threshold':
            fieldsHTML = `
                <div class="form-group"><label>Daily Rate ($)</label><input type="number" id="dailyRate" step="0.01" min="0" required></div>
                <div class="form-group"><label>Stop Rate ($)</label><input type="number" id="stopRate" step="0.01" min="0" required></div>
                <div class="form-group"><label>Threshold (stops)</label><input type="number" id="threshold" min="0" required></div>
            `;
            break;
        case 'hybrid':
            fieldsHTML = `
                <div class="form-group"><label>Daily Rate ($)</label><input type="number" id="dailyRate" step="0.01" min="0" required></div>
                <div class="form-group"><label>Stop Pay Trigger (stops)</label><input type="number" id="stopPayTrigger" min="0" required></div>
                <div class="form-group"><label>Stop Pay Rate ($)</label><input type="number" id="stopPayRate" step="0.01" min="0" required></div>
                <div style="border: 2px solid #28a745; border-radius: 5px; padding: 15px; margin: 10px 0;">
                    <h4 style="margin-bottom: 15px; color: #28a745;">Stop Bonus Tiers</h4>
                    <div id="bonusTiers">
                        <div class="bonus-tier" data-tier="1">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;"><label>Stop Threshold</label><input type="number" id="stopThreshold1" min="0" required></div>
                                <div style="flex: 1;"><label>Bonus Amount ($)</label><input type="number" id="bonusAmount1" step="0.01" min="0" required></div>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addBonusTier()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; margin-top: 10px;">+ Add Another Bonus Tier</button>
                </div>
            `;
            break;
        default:
            fieldsHTML = '<p>Additional configuration options would be implemented here.</p>';
    }

    dynamicFields.innerHTML = fieldsHTML;
}

function addBonusTier() {
    const container = document.getElementById('bonusTiers');
    const tierCount = container.querySelectorAll('.bonus-tier').length + 1;
    
    const newTier = document.createElement('div');
    newTier.className = 'bonus-tier';
    newTier.setAttribute('data-tier', tierCount);
    newTier.innerHTML = `
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <div style="flex: 1;"><label>Stop Threshold</label><input type="number" id="stopThreshold${tierCount}" min="0" required></div>
            <div style="flex: 1;"><label>Bonus Amount ($)</label><input type="number" id="bonusAmount${tierCount}" step="0.01" min="0" required></div>
            <button type="button" onclick="removeBonusTier(${tierCount})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; align-self: end;">Remove</button>
        </div>
    `;
    container.appendChild(newTier);
}

function removeBonusTier(tierNumber) {
    const tier = document.querySelector(`[data-tier="${tierNumber}"]`);
    if (tier) tier.remove();
}

async function saveDriverData() {
    let driverName;
    let isOnboarding = currentOnboardingDrivers.length > 0 && currentOnboardingIndex < currentOnboardingDrivers.length;
    let isEditing = false;
    
    if (isOnboarding) {
        driverName = currentOnboardingDrivers[currentOnboardingIndex];
    } else if (currentEditingDriver) {
        driverName = currentEditingDriver;
        isEditing = true;
    } else {
        const newDriverNameInput = document.getElementById('newDriverName');
        if (newDriverNameInput) {
            driverName = newDriverNameInput.value.trim();
            if (!driverName) {
                showStatus('Please enter a driver name', 'error');
                return;
            }
        } else {
            showStatus('Driver name required', 'error');
            return;
        }
    }
    
    const paymentMethod = document.getElementById('paymentMethod').value;
    if (!paymentMethod) {
        showStatus('Please select a payment method', 'error');
        return;
    }

    const driverInfo = {
        paymentMethod: paymentMethod,
        attendanceBonus: document.getElementById('attendanceBonus').checked,
        setupDate: new Date().toISOString()
    };

    if (driverInfo.attendanceBonus) {
        const attendanceDays = document.getElementById('attendanceDays');
        const bonusAmount = document.getElementById('bonusAmount');
        if (attendanceDays && attendanceDays.value) {
            driverInfo.attendanceDaysRequired = parseInt(attendanceDays.value);
        }
        if (bonusAmount && bonusAmount.value) {
            driverInfo.attendanceBonusAmount = parseFloat(bonusAmount.value);
        }
    }

    const dailyRate = document.getElementById('dailyRate');
    const hourlyRate = document.getElementById('hourlyRate');
    const salaryAmount = document.getElementById('salaryAmount');
    const stopRate = document.getElementById('stopRate');
    const stopPayTrigger = document.getElementById('stopPayTrigger');
    const stopPayRate = document.getElementById('stopPayRate');
    const threshold = document.getElementById('threshold');
    
    if (dailyRate && dailyRate.value) driverInfo.dailyRate = parseFloat(dailyRate.value);
    if (hourlyRate && hourlyRate.value) driverInfo.hourlyRate = parseFloat(hourlyRate.value);
    if (salaryAmount && salaryAmount.value) driverInfo.salary = parseFloat(salaryAmount.value);
    if (stopRate && stopRate.value) driverInfo.stopRate = parseFloat(stopRate.value);
    if (stopPayTrigger && stopPayTrigger.value) driverInfo.stopPayTrigger = parseInt(stopPayTrigger.value);
    if (stopPayRate && stopPayRate.value) driverInfo.stopPayRate = parseFloat(stopPayRate.value);
    if (threshold && threshold.value) driverInfo.threshold = parseInt(threshold.value);

    const bonusTierElements = document.querySelectorAll('.bonus-tier');
    if (bonusTierElements.length > 0) {
        const bonusTiers = [];
        bonusTierElements.forEach((tier, index) => {
            const tierNumber = index + 1;
            const thresholdInput = document.getElementById(`stopThreshold${tierNumber}`);
            const bonusInput = document.getElementById(`bonusAmount${tierNumber}`);
            
            if (thresholdInput && thresholdInput.value && bonusInput && bonusInput.value) {
                bonusTiers.push({
                    threshold: parseInt(thresholdInput.value),
                    bonusAmount: parseFloat(bonusInput.value)
                });
            }
        });
        if (bonusTiers.length > 0) {
            driverInfo.bonusTiers = bonusTiers;
        }
    }

    driverData.set(driverName, driverInfo);
    
    try {
        const response = await fetch('/api/drivers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: driverName, config: driverInfo })
        });
        
        if (!response.ok) {
            console.warn('Failed to save to server, using local storage only');
        }
    } catch (error) {
        console.warn('Server save failed, using local storage only');
    }
    
    if (isOnboarding) {
        showStatus(`Driver ${driverName} configured successfully!`, 'success');
        currentOnboardingIndex++;
        closeDriverModalSilently();
        
        setTimeout(() => {
            showNextDriverOnboarding();
        }, 500);
    } else {
        if (isEditing) {
            showStatus(`Driver ${driverName} updated successfully!`, 'success');
            currentEditingDriver = null;
        } else {
            showStatus(`Driver ${driverName} saved successfully!`, 'success');
        }
        
        closeDriverModal();
        
        const managementResults = document.getElementById('driverManagementResults');
        if (managementResults.style.display !== 'none') {
            displayDriverManagement();
        }
    }
}

// PAY CALCULATION FUNCTIONS
function calculateDriverPay(driverData, driverConfig, dates) {
    const paymentMethod = driverConfig.paymentMethod;
    let totalPay = 0;
    let dailyBreakdown = {};
    
    // Calculate base pay based on method
    switch (paymentMethod) {
        case 'salary':
            totalPay = calculateSalaryPay(driverConfig);
            break;
            
        case 'hourly':
            totalPay = calculateHourlyPay(driverData, driverConfig, dates);
            break;
            
        case 'daily_rate':
            totalPay = calculateDailyRatePay(driverData, driverConfig, dates);
            break;
            
        case 'stop_rate':
            totalPay = calculateStopRatePay(driverData, driverConfig, dates);
            break;
            
        case 'daily_stop':
            totalPay = calculateDailyStopPay(driverData, driverConfig, dates);
            break;
            
        case 'daily_stop_bonus':
            const result1 = calculateDailyStopBonusPay(driverData, driverConfig, dates);
            totalPay = result1.totalPay;
            dailyBreakdown = result1.dailyBreakdown;
            break;
            
        case 'daily_stop_threshold':
            const result2 = calculateDailyStopThresholdPay(driverData, driverConfig, dates);
            totalPay = result2.totalPay;
            dailyBreakdown = result2.dailyBreakdown;
            break;
            
        case 'hybrid':
            const result3 = calculateHybridPay(driverData, driverConfig, dates);
            totalPay = result3.totalPay;
            dailyBreakdown = result3.dailyBreakdown;
            break;
            
        default:
            totalPay = 0;
    }
    
    // Add attendance bonus if applicable
    if (driverConfig.attendanceBonus) {
        const attendanceBonus = calculateAttendanceBonus(driverData, driverConfig, dates);
        totalPay += attendanceBonus;
    }
    
    return {
        totalPay: Math.round(totalPay * 100) / 100, // Round to 2 decimal places
        dailyBreakdown: dailyBreakdown
    };
}

// 1. Salary: weekly salary
function calculateSalaryPay(driverConfig) {
    return driverConfig.salary; // Weekly salary amount
}

// 2. Hourly: hours worked x hourly rate
function calculateHourlyPay(driverData, driverConfig, dates) {
    let totalHours = 0;
    dates.forEach(date => {
        if (driverData[date]) {
            totalHours += driverData[date].hours || 0;
        }
    });
    return totalHours * driverConfig.hourlyRate;
}

// 3. Daily rate: # of days worked x daily rate
function calculateDailyRatePay(driverData, driverConfig, dates) {
    let daysWorked = 0;
    dates.forEach(date => {
        if (driverData[date] && (driverData[date].totalStops > 0 || driverData[date].hours > 0)) {
            daysWorked++;
        }
    });
    return daysWorked * driverConfig.dailyRate;
}

// 4. Stop rate: # of stops x stop rate
function calculateStopRatePay(driverData, driverConfig, dates) {
    let totalStops = 0;
    dates.forEach(date => {
        if (driverData[date]) {
            totalStops += driverData[date].totalStops || 0;
        }
    });
    return totalStops * driverConfig.stopRate;
}

// 5. Daily + Stop: (days worked x daily rate) + (stops x stop rate)
function calculateDailyStopPay(driverData, driverConfig, dates) {
    const dailyPay = calculateDailyRatePay(driverData, driverConfig, dates);
    const stopPay = calculateStopRatePay(driverData, driverConfig, dates);
    return dailyPay + stopPay;
}

// 6. Daily + Stop Bonus: calculated daily, summed at end of week
function calculateDailyStopBonusPay(driverData, driverConfig, dates) {
    let totalPay = 0;
    let dailyBreakdown = {};
    
    dates.forEach(date => {
        let dayPay = 0;
        const dayData = driverData[date];
        
        if (dayData && (dayData.totalStops > 0 || dayData.hours > 0)) {
            // Daily rate for working
            dayPay += driverConfig.dailyRate;
            
            // Check for stop bonus tiers
            const stops = dayData.totalStops || 0;
            if (driverConfig.bonusTiers && stops > 0) {
                // Apply highest qualifying bonus tier
                const qualifyingTiers = driverConfig.bonusTiers
                    .filter(tier => stops >= tier.threshold)
                    .sort((a, b) => b.threshold - a.threshold);
                
                if (qualifyingTiers.length > 0) {
                    dayPay += qualifyingTiers[0].bonusAmount;
                }
            }
        }
        
        dailyBreakdown[date] = dayPay;
        totalPay += dayPay;
    });
    
    return { totalPay, dailyBreakdown };
}

// 7. Daily + Stop Threshold: daily rate + stops over threshold paid at stop rate
function calculateDailyStopThresholdPay(driverData, driverConfig, dates) {
    let totalPay = 0;
    let dailyBreakdown = {};
    
    dates.forEach(date => {
        let dayPay = 0;
        const dayData = driverData[date];
        
        if (dayData && (dayData.totalStops > 0 || dayData.hours > 0)) {
            // Daily rate for working
            dayPay += driverConfig.dailyRate;
            
            // Additional pay for stops over threshold
            const stops = dayData.totalStops || 0;
            if (stops > driverConfig.threshold) {
                const extraStops = stops - driverConfig.threshold;
                dayPay += extraStops * driverConfig.stopRate;
            }
        }
        
        dailyBreakdown[date] = dayPay;
        totalPay += dayPay;
    });
    
    return { totalPay, dailyBreakdown };
}

// 8. Hybrid: complex daily calculation
function calculateHybridPay(driverData, driverConfig, dates) {
    let totalPay = 0;
    let dailyBreakdown = {};
    
    dates.forEach(date => {
        let dayPay = 0;
        const dayData = driverData[date];
        
        if (dayData && (dayData.totalStops > 0 || dayData.hours > 0)) {
            const stops = dayData.totalStops || 0;
            
            // Base pay logic
            if (stops < driverConfig.stopPayTrigger) {
                // Pay daily rate if under trigger
                dayPay += driverConfig.dailyRate;
            } else {
                // Pay stop rate if over trigger
                dayPay += stops * driverConfig.stopPayRate;
            }
            
            // Check for bonus tiers
            if (driverConfig.bonusTiers && stops > 0) {
                const qualifyingTiers = driverConfig.bonusTiers
                    .filter(tier => stops >= tier.threshold)
                    .sort((a, b) => b.threshold - a.threshold);
                
                if (qualifyingTiers.length > 0) {
                    dayPay += qualifyingTiers[0].bonusAmount;
                }
            }
        }
        
        dailyBreakdown[date] = dayPay;
        totalPay += dayPay;
    });
    
    return { totalPay, dailyBreakdown };
}

// Attendance bonus calculation
function calculateAttendanceBonus(driverData, driverConfig, dates) {
    if (!driverConfig.attendanceBonus || !driverConfig.attendanceDaysRequired || !driverConfig.attendanceBonusAmount) {
        return 0;
    }
    
    let daysWorked = 0;
    dates.forEach(date => {
        if (driverData[date] && (driverData[date].totalStops > 0 || driverData[date].hours > 0)) {
            daysWorked++;
        }
    });
    
    return daysWorked >= driverConfig.attendanceDaysRequired ? driverConfig.attendanceBonusAmount : 0;
}

// Enhanced display function that includes pay calculations
function displayAllStationsWithPayCalculation(stationResults) {
    // Initialize edited data
    initializeEditedData();
    
    const stationResultsDiv = document.getElementById('stationResults');
    stationResultsDiv.innerHTML = '';
    
    const sortedStations = Object.keys(stationResults).sort();
    
    sortedStations.forEach(stationCode => {
        const stationData = stationResults[stationCode];
        
        // Calculate pay for each driver
        const enhancedWeeklyData = stationData.weeklyData.map(driver => {
            const driverConfig = driverData.get(driver.driver);
            let calculatedPay = 0;
            
            if (driverConfig) {
                const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                calculatedPay = payResult.totalPay;
            }
            
            return {
                ...driver,
                calculatedPay: calculatedPay
            };
        });
        
        const stationSection = document.createElement('div');
        stationSection.className = 'station-section';
        stationSection.setAttribute('data-station', stationCode);
        
        const stationHeader = document.createElement('div');
        stationHeader.className = 'station-header';
        stationHeader.innerHTML = `
            <div style="font-size: 1.3rem; font-weight: bold;">${stationCode}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">${stationData.files.length} files | ${stationData.weeklyData.length} drivers | ${stationData.dates[0]} to ${stationData.dates[stationData.dates.length - 1]}</div>
        `;
        
        const stationContent = document.createElement('div');
        stationContent.className = 'station-content';
        
        // Add editing instructions
        const editInstructions = document.createElement('div');
        editInstructions.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin-bottom: 15px; border-radius: 5px; text-align: center;';
        editInstructions.innerHTML = `
            <strong> Tip:</strong> Click on any Stops, Hours, or Weekly Pay cell to edit the data. 
            Totals will automatically recalculate when you make changes.
        `;
        stationContent.appendChild(editInstructions);
        
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';
        
        const table = document.createElement('table');
        table.innerHTML = createEditableTableWithPayHTML(stationData.dates, enhancedWeeklyData, stationCode);
        
        tableWrapper.appendChild(table);
        stationContent.appendChild(tableWrapper);
        
        const downloadSection = document.createElement('div');
        downloadSection.className = 'download-section';
        downloadSection.innerHTML = `
            <button onclick="downloadStationWithEditedData('${stationCode}')" style="background: #17a2b8; color: white; border: none; padding: 15px 30px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 1.1rem;">
                Download ${stationCode} HTML Report (with edits)
            </button>
            <button onclick="exportStationToExcelWithEditedData('${stationCode}')" style="background: #28a745; color: white; border: none; padding: 15px 30px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 1.1rem;">
                Export ${stationCode} to Excel (with edits)
            </button>
        `;
        
        stationSection.appendChild(stationHeader);
        stationSection.appendChild(stationContent);
        stationSection.appendChild(downloadSection);
        
        stationResultsDiv.appendChild(stationSection);
    });
    
    document.getElementById('resultsSection').style.display = 'block';
}


// Enhanced table creation with editable pay cells
function createEditableTableWithPayHTML(dates, weeklyData, stationCode) {
    let headerHTML = `
        <thead>
            <tr>
                <th rowspan="2" class="employee-name">Employee Name</th>`;
    
    dates.forEach(date => {
        headerHTML += `<th colspan="2" class="date-header">${date}</th>`;
    });
    
    headerHTML += `
                <th rowspan="2" class="total-column">Days</th>
                <th rowspan="2" class="total-column">Total Stops</th>
                <th rowspan="2" class="total-column">Total Hours</th>
                <th rowspan="2" class="pay-column">Weekly Pay ($)</th>
            </tr>
            <tr>`;
    
    dates.forEach(() => {
        headerHTML += `<th>Stops</th><th>Hours</th>`;
    });
    
    headerHTML += `</tr></thead><tbody>`;
    
    let totalPayroll = 0;
    
    weeklyData.forEach(driver => {
        let totalStops = 0;
        let totalHours = 0;
        let daysWorked = 0;
        
        let rowHTML = `<tr><td class="employee-name">${driver.driver}</td>`;
        
        dates.forEach(date => {
            const dayData = driver.dates[date];
            if (dayData.totalStops > 0 || dayData.hours > 0) {
                // Make stops and hours cells editable
                rowHTML += `<td onclick="makeEditable(this, '${stationCode}', '${driver.driver}', '${date}', 'stops')" style="cursor: pointer; background: #f8f9fa;" title="Click to edit">${dayData.totalStops}</td>`;
                rowHTML += `<td onclick="makeEditable(this, '${stationCode}', '${driver.driver}', '${date}', 'hours')" style="cursor: pointer; background: #f8f9fa;" title="Click to edit">${dayData.hours}</td>`;
                totalStops += dayData.totalStops;
                totalHours += dayData.hours;
                daysWorked++;
            } else {
                rowHTML += `<td onclick="makeEditable(this, '${stationCode}', '${driver.driver}', '${date}', 'stops')" style="cursor: pointer; background: #f8f9fa;" title="Click to edit">0</td>`;
                rowHTML += `<td onclick="makeEditable(this, '${stationCode}', '${driver.driver}', '${date}', 'hours')" style="cursor: pointer; background: #f8f9fa;" title="Click to edit">0</td>`;
            }
        });
        
        const weeklyPay = driver.calculatedPay || 0;
        totalPayroll += weeklyPay;
        
        rowHTML += `<td class="total-column">${daysWorked}</td>`;
        rowHTML += `<td class="total-column">${totalStops}</td>`;
        rowHTML += `<td class="total-column">${totalHours}</td>`;
        // Make pay cell editable too
        rowHTML += `<td class="pay-column" onclick="makeEditable(this, '${stationCode}', '${driver.driver}', '', 'pay')" style="cursor: pointer;" title="Click to edit pay">$${weeklyPay.toFixed(2)}</td></tr>`;
        
        headerHTML += rowHTML;
    });
    
    // Add total row
    headerHTML += `
        <tr style="background: #f8f9fa; font-weight: bold; border-top: 3px solid #333;">
            <td class="employee-name">TOTAL PAYROLL</td>`;
    
    // Empty cells for daily data
    dates.forEach(() => {
        headerHTML += '<td></td><td></td>';
    });
    
    headerHTML += `
            <td class="total-column"></td>
            <td class="total-column"></td>
            <td class="total-column"></td>
            <td class="total-payroll">$${totalPayroll.toFixed(2)}</td>
        </tr>`;
    
    headerHTML += '</tbody>';
    return headerHTML;
}

// Enhanced table creation with pay column
function createTableWithPayHTML(dates, weeklyData) {
    let headerHTML = `
        <thead>
            <tr>
                <th rowspan="2" class="employee-name">Employee Name</th>`;
    
    dates.forEach(date => {
        headerHTML += `<th colspan="2" class="date-header">${date}</th>`;
    });
    
    headerHTML += `
                <th rowspan="2" class="total-column">Days</th>
                <th rowspan="2" class="total-column">Total Stops</th>
                <th rowspan="2" class="total-column">Total Hours</th>
                <th rowspan="2" class="pay-column">Weekly Pay ($)</th>
            </tr>
            <tr>`;
    
    dates.forEach(() => {
        headerHTML += `<th>Stops</th><th>Hours</th>`;
    });
    
    headerHTML += `</tr></thead><tbody>`;
    
    let totalPayroll = 0;
    
    weeklyData.forEach(driver => {
        let totalStops = 0;
        let totalHours = 0;
        let daysWorked = 0;
        
        let rowHTML = `<tr><td class="employee-name">${driver.driver}</td>`;
        
        dates.forEach(date => {
            const dayData = driver.dates[date];
            if (dayData.totalStops > 0 || dayData.hours > 0) {
                rowHTML += `<td>${dayData.totalStops}</td><td>${dayData.hours}</td>`;
                totalStops += dayData.totalStops;
                totalHours += dayData.hours;
                daysWorked++;
            } else {
                rowHTML += '<td></td><td></td>';
            }
        });
        
        const weeklyPay = driver.calculatedPay || 0;
        totalPayroll += weeklyPay;
        
        rowHTML += `<td class="total-column">${daysWorked}</td>`;
        rowHTML += `<td class="total-column">${totalStops}</td>`;
        rowHTML += `<td class="total-column">${totalHours}</td>`;
        rowHTML += `<td class="pay-column">$${weeklyPay.toFixed(2)}</td></tr>`;
        
        headerHTML += rowHTML;
    });
    
    // Add total row
    headerHTML += `
        <tr style="background: #f8f9fa; font-weight: bold; border-top: 3px solid #333;">
            <td class="employee-name">TOTAL PAYROLL</td>`;
    
    // Empty cells for daily data
    dates.forEach(() => {
        headerHTML += '<td></td><td></td>';
    });
    
    headerHTML += `
            <td class="total-column"></td>
            <td class="total-column"></td>
            <td class="total-column"></td>
            <td class="total-payroll">$${totalPayroll.toFixed(2)}</td>
        </tr>`;
    
    headerHTML += '</tbody>';
    return headerHTML;
}

function downloadStationWithPay(stationCode, stationDataJson) {
    try {
        let stationData;
        
        // Handle both string and object inputs
        if (typeof stationDataJson === 'string') {
            stationData = JSON.parse(stationDataJson.replace(/&quot;/g, '"'));
        } else {
            stationData = stationDataJson;
        }
        
        generateStationHTMLWithPay(stationCode, stationData.dates, stationData.weeklyData, stationData);
    } catch (error) {
        console.error('Download error:', error);
        showStatus(`Download error: ${error.message}`, 'error');
    }
}
function generateStationHTMLWithPay(stationCode, dates, weeklyData, stationData) {
    let totalPayroll = 0;
    
    let htmlContent = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${stationCode} - Weekly Payroll Summary with Pay</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.header { text-align: center; margin-bottom: 20px; }
.header h1 { color: #4a5568; margin: 0; }
.header p { margin: 5px 0; color: #666; }
table { border-collapse: collapse; width: 100%; margin: 0; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
th { background-color: #4a5568; color: white; font-weight: bold; }
.employee-name { text-align: left; font-weight: bold; background-color: #f8f9fa; }
.total-column { background-color: #FFFF00; font-weight: bold; color: #000; }
.pay-column { background-color: #28a745; color: white; font-weight: bold; }
.total-payroll { background-color: #dc3545; color: white; font-weight: bold; font-size: 1.2rem; }
.footer { margin-top: 20px; text-align: center; font-size: 12px; color: #666; }
</style></head><body>
<div class="header">
<h1>${stationCode} - WEEKLY PAYROLL SUMMARY</h1>
<p>Week: ${dates[0]} to ${dates[dates.length - 1]}</p>
<p>Generated: ${new Date().toLocaleDateString()}</p>
</div>
<table><thead><tr><th rowspan="2">EMPLOYEE NAME</th>`;

    dates.forEach(date => {
        htmlContent += `<th colspan="2">${date}</th>`;
    });
    htmlContent += `<th colspan="4">WEEKLY TOTALS</th></tr><tr>`;
    
    dates.forEach(() => {
        htmlContent += `<th>Stops</th><th>Hours</th>`;
    });
    htmlContent += `<th>Days</th><th>Total Stops</th><th>Total Hours</th><th class="pay-column">Weekly Pay ($)</th></tr></thead><tbody>`;

    weeklyData.forEach(driver => {
        let totalStops = 0, totalHours = 0, daysWorked = 0;
        htmlContent += `<tr><td class="employee-name">${driver.driver.toUpperCase()}</td>`;
        
        dates.forEach(date => {
            const dayData = driver.dates[date];
            if (dayData.totalStops > 0 || dayData.hours > 0) {
                htmlContent += `<td>${dayData.totalStops}</td><td>${dayData.hours}</td>`;
                totalStops += dayData.totalStops;
                totalHours += dayData.hours;
                daysWorked++;
            } else {
                htmlContent += `<td></td><td></td>`;
            }
        });
        
        const weeklyPay = driver.calculatedPay || 0;
        totalPayroll += weeklyPay;
        
        htmlContent += `<td class="total-column">${daysWorked}</td><td class="total-column">${totalStops}</td><td class="total-column">${totalHours}</td><td class="pay-column">$${weeklyPay.toFixed(2)}</td></tr>`;
    });
    
    // Add total payroll row
    htmlContent += `<tr style="border-top: 3px solid #333;"><td class="employee-name">TOTAL PAYROLL</td>`;
    dates.forEach(() => {
        htmlContent += '<td></td><td></td>';
    });
    htmlContent += `<td class="total-column"></td><td class="total-column"></td><td class="total-column"></td><td class="total-payroll">$${totalPayroll.toFixed(2)}</td></tr>`;
    
    htmlContent += `</tbody></table>
<div class="footer">
<p>Total Drivers: ${weeklyData.length} | Total Weekly Payroll: $${totalPayroll.toFixed(2)} | Generated by Payroll Summary Generator</p>
</div></body></html>`;

    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${stationCode.replace(/\//g, '_')}_Payroll_Summary_With_Pay_${Date.now()}.html`;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showStatus(`${stationCode} payroll summary with pay calculations downloaded successfully!`, 'success');
}

// EXCEL EXPORT FUNCTIONS
function exportStationToExcel(stationCode, stationDataJson) {
    try {
        let stationData;
        
        // Handle both string and object inputs
        if (typeof stationDataJson === 'string') {
            stationData = JSON.parse(stationDataJson.replace(/&quot;/g, '"'));
        } else {
            stationData = stationDataJson;
        }
        
        let csvContent = "Driver Name,";
        
        // Add date headers
        stationData.dates.forEach(date => {
            csvContent += `"${date} Stops","${date} Hours",`;
        });
        csvContent += "Days Worked,Total Stops,Total Hours,Weekly Pay,Payment Method\n";
        
        // Add driver data
        stationData.weeklyData.forEach(driver => {
            const driverConfig = driverData.get(driver.driver);
            let calculatedPay = 0;
            let paymentMethod = 'Not Configured';
            
            if (driverConfig) {
                const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                calculatedPay = payResult.totalPay;
                paymentMethod = formatPaymentMethod(driverConfig.paymentMethod);
            }
            
            csvContent += `"${driver.driver}",`;
            
            // Add daily data
            let totalStops = 0, totalHours = 0, daysWorked = 0;
            stationData.dates.forEach(date => {
                const dayData = driver.dates[date];
                if (dayData.totalStops > 0 || dayData.hours > 0) {
                    csvContent += `${dayData.totalStops},${dayData.hours},`;
                    totalStops += dayData.totalStops;
                    totalHours += dayData.hours;
                    daysWorked++;
                } else {
                    csvContent += "0,0,";
                }
            });
            
            csvContent += `${daysWorked},${totalStops},${totalHours},${calculatedPay.toFixed(2)},"${paymentMethod}"\n`;
        });
        
        // Add total row
        let totalPayroll = 0;
        let totalDrivers = stationData.weeklyData.length;
        stationData.weeklyData.forEach(driver => {
            const driverConfig = driverData.get(driver.driver);
            if (driverConfig) {
                const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                totalPayroll += payResult.totalPay;
            }
        });
        
        csvContent += `"TOTAL PAYROLL (${totalDrivers} drivers)",`;
        // Add empty cells for daily data
        stationData.dates.forEach(() => {
            csvContent += ",,";
        });
        csvContent += `,,,$${totalPayroll.toFixed(2)},\n`;
        
        downloadExcelFile(csvContent, `${stationCode.replace(/\//g, '_')}_Payroll_Detail`);
        
    } catch (error) {
        console.error('Export error:', error);
        showStatus(`Export error: ${error.message}`, 'error');
    }
}

function exportAllStationsToExcel() {
    if (!lastProcessedResults) {
        showStatus('No payroll data available. Please generate summaries first.', 'error');
        return;
    }

    let csvContent = "Station,Driver Name,Days Worked,Total Stops,Total Hours,Weekly Pay,Payment Method,Date Range\n";
    
    Object.keys(lastProcessedResults).forEach(stationCode => {
        const stationData = lastProcessedResults[stationCode];
        const dateRange = `${stationData.dates[0]} to ${stationData.dates[stationData.dates.length - 1]}`;
        
        stationData.weeklyData.forEach(driver => {
            const driverConfig = driverData.get(driver.driver);
            let calculatedPay = 0;
            let paymentMethod = 'Not Configured';
            
            if (driverConfig) {
                const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                calculatedPay = payResult.totalPay;
                paymentMethod = formatPaymentMethod(driverConfig.paymentMethod);
            }
            
            // Calculate totals
            let totalStops = 0, totalHours = 0, daysWorked = 0;
            stationData.dates.forEach(date => {
                const dayData = driver.dates[date];
                if (dayData.totalStops > 0 || dayData.hours > 0) {
                    totalStops += dayData.totalStops;
                    totalHours += dayData.hours;
                    daysWorked++;
                }
            });
            
            csvContent += `"${stationCode}","${driver.driver}",${daysWorked},${totalStops},${totalHours},${calculatedPay.toFixed(2)},"${paymentMethod}","${dateRange}"\n`;
        });
    });
    
    downloadExcelFile(csvContent, 'Payroll_Summary_All_Stations');
}

function exportPayrollSummaryToExcel() {
    if (!lastProcessedResults) {
        showStatus('No payroll data available. Please generate summaries first.', 'error');
        return;
    }

    let csvContent = "Station Code,Total Drivers,Total Weekly Payroll,Date Range\n";
    
    Object.keys(lastProcessedResults).forEach(stationCode => {
        const stationData = lastProcessedResults[stationCode];
        const dateRange = `${stationData.dates[0]} to ${stationData.dates[stationData.dates.length - 1]}`;
        
        let totalPayroll = 0;
        stationData.weeklyData.forEach(driver => {
            const driverConfig = driverData.get(driver.driver);
            if (driverConfig) {
                const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                totalPayroll += payResult.totalPay;
            }
        });
        
        csvContent += `"${stationCode}",${stationData.weeklyData.length},$${totalPayroll.toFixed(2)},"${dateRange}"\n`;
    });
    
    downloadExcelFile(csvContent, 'Payroll_Summary_By_Station');
}

function downloadExcelFile(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${filename}_${new Date().toISOString().slice(0, 10)}.csv`;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showStatus(`${filename} Excel file downloaded successfully!`, 'success');
}



function exportPayrollTimeTable() {
    if (!lastProcessedResults) {
        showStatus('No payroll data available. Please generate summaries first.', 'error');
        return;
    }

    // Column headers matching the uploaded format
    let csvContent = "Name,Hourly Rate,Hours,OT Hours,Overtime Rate,Salary,Bonus,Gross Pay\n";
    
    let allDrivers = [];
    
    // Collect all drivers from all stations
    Object.keys(lastProcessedResults).forEach(stationCode => {
        const stationData = lastProcessedResults[stationCode];
        
        stationData.weeklyData.forEach(driver => {
            const driverConfig = driverData.get(driver.driver);
            let calculatedPay = 0;
            
            if (driverConfig) {
                const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                calculatedPay = payResult.totalPay;
            }
            
            // Calculate total hours
            let totalHours = 0;
            stationData.dates.forEach(date => {
                const dayData = driver.dates[date];
                totalHours += dayData.hours || 0;
            });
            
            // Calculate regular and OT hours
            const regularHours = Math.min(totalHours, 40);
            const otHours = Math.max(0, totalHours - 40);
            
            // Determine if driver is salaried
            const isSalaried = driverConfig && driverConfig.paymentMethod === 'salary';
            
            let salary = 0;
            let bonus = 0;
            
            if (isSalaried) {
                salary = 500; // Fixed $500 for salaried employees
                bonus = Math.max(0, calculatedPay - 500); // Remainder as bonus
            } else {
                salary = 0;
                // For non-salaried: Bonus = Gross Pay - ((Hourly Rate  Hours) + (OT Hours  OT Rate))
                const regularPay = regularHours * 15; // $15 hourly rate
                const otPay = otHours * 22.50; // $22.50 OT rate
                bonus = Math.max(0, calculatedPay - (regularPay + otPay));
            }
            
           allDrivers.push({
    		name: driver.driver,
    		hourlyRate: 15,
    		hours: regularHours,
    		otHours: otHours,
    		overtimeRate: 22.50,
    		salary: salary,
    		bonus: bonus,
    		grossPay: calculatedPay || 0
		});
        });
    });
    
    // Sort drivers alphabetically by name
    allDrivers.sort((a, b) => a.name.localeCompare(b.name));
    
    // Add driver data to CSV
allDrivers.forEach(driver => {
    csvContent += `"${driver.name}",${driver.hourlyRate},${(driver.hours || 0).toFixed(2)},${(driver.otHours || 0).toFixed(2)},${driver.overtimeRate},${(driver.salary || 0).toFixed(2)},${(driver.bonus || 0).toFixed(2)},${(driver.grossPay || 0).toFixed(2)}\n`;
});
    
    // Add totals row
    const totalRegularHours = allDrivers.reduce((sum, d) => sum + d.hours, 0);
    const totalOTHours = allDrivers.reduce((sum, d) => sum + d.otHours, 0);
    const totalSalary = allDrivers.reduce((sum, d) => sum + d.salary, 0);
    const totalBonus = allDrivers.reduce((sum, d) => sum + d.bonus, 0);
    const totalGrossPay = allDrivers.reduce((sum, d) => sum + d.grossPay, 0);
    
    csvContent += `"TOTALS",,${totalRegularHours.toFixed(2)},${totalOTHours.toFixed(2)},,${totalSalary.toFixed(2)},${totalBonus.toFixed(2)},${totalGrossPay.toFixed(2)}\n`;
    
    // Download the file
    downloadExcelFile(csvContent, 'Payroll_Time_Table');
    
    showStatus(`Payroll Time Table exported successfully! ${allDrivers.length} drivers included.`, 'success');
}

// Store edited data globally
let editedPayrollData = {};

// Initialize edited data from original results
function initializeEditedData() {
    editedPayrollData = JSON.parse(JSON.stringify(lastProcessedResults));
    
    // Ensure all drivers have calculated pay properly set
    Object.keys(editedPayrollData).forEach(stationCode => {
        const stationData = editedPayrollData[stationCode];
        stationData.weeklyData.forEach(driver => {
            // If calculatedPay is missing or 0, recalculate it
            if (!driver.calculatedPay || driver.calculatedPay === 0) {
                const driverConfig = driverData.get(driver.driver);
                if (driverConfig) {
                    const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                    driver.calculatedPay = payResult.totalPay;
                }
            }
        });
    });
}
		
// Make a cell editable (including pay cells)
function makeEditable(cell, stationCode, driverName, date, field) {
    const currentValue = cell.textContent.replace('$', ''); // Remove $ for pay cells
    const input = document.createElement('input');
    input.type = 'number';
    input.step = field === 'hours' ? '0.5' : (field === 'pay' ? '0.01' : '1');
    input.min = '0';
    input.value = currentValue;
    input.style.width = field === 'pay' ? '100px' : '60px';
    input.style.textAlign = 'center';
    input.style.border = '2px solid #007bff';
    input.style.backgroundColor = '#fff3cd';
    
    // Save on Enter or blur
    function saveEdit() {
        const newValue = parseFloat(input.value) || 0;
        
        if (field === 'pay') {
            cell.textContent = `$${newValue.toFixed(2)}`;
        } else {
            cell.textContent = newValue;
        }
        
        cell.style.backgroundColor = newValue !== parseFloat(currentValue) ? '#d1ecf1' : '';
        
        // Update the edited data
        if (!editedPayrollData[stationCode]) return;
        
        const driverRowData = editedPayrollData[stationCode].weeklyData.find(d => d.driver === driverName);
        if (driverRowData) {
            if (field === 'pay') {
                // Update calculated pay directly
                driverRowData.calculatedPay = newValue;
            } else if (driverRowData.dates[date]) {
                if (field === 'stops') {
                    driverRowData.dates[date].totalStops = newValue;
                } else if (field === 'hours') {
                    driverRowData.dates[date].hours = newValue;
                }
            }
        }
        
        // Recalculate totals and pay for this row (except if manually editing pay)
        if (field !== 'pay') {
            recalculateRowTotals(stationCode, driverName);
        } else {
            // If manually editing pay, just update station totals
            recalculateStationTotals(stationCode);
        }
        
        // Make cell editable again on click
        cell.onclick = () => makeEditable(cell, stationCode, driverName, date, field);
    }
    
    input.onblur = saveEdit;
    input.onkeydown = (e) => {
        if (e.key === 'Enter') {
            input.blur();
        } else if (e.key === 'Escape') {
            cell.textContent = field === 'pay' ? `$${parseFloat(currentValue).toFixed(2)}` : currentValue;
            cell.onclick = () => makeEditable(cell, stationCode, driverName, date, field);
        }
    };
    
    cell.textContent = '';
    cell.appendChild(input);
    input.focus();
    input.select();
    
    // Remove click handler temporarily
    cell.onclick = null;
}

// Fixed recalculate function
function recalculateRowTotals(stationCode, driverName) {
    if (!editedPayrollData[stationCode]) return;
    
    const stationData = editedPayrollData[stationCode];
    const driverRowData = stationData.weeklyData.find(d => d.driver === driverName);
    if (!driverRowData) return;
    
    // Calculate new totals
    let totalStops = 0;
    let totalHours = 0;
    let daysWorked = 0;
    
    stationData.dates.forEach(date => {
        const dayData = driverRowData.dates[date];
        if (dayData.totalStops > 0 || dayData.hours > 0) {
            totalStops += dayData.totalStops;
            totalHours += dayData.hours;
            daysWorked++;
        }
    });
    
    // Recalculate pay using global driver config
    const driverConfig = driverData.get(driverName);
    let newPay = 0;
    if (driverConfig) {
        const payResult = calculateDriverPay(driverRowData.dates, driverConfig, stationData.dates);
        newPay = payResult.totalPay;
    }
    
    // Store the new calculated pay
    driverRowData.calculatedPay = newPay;
    
    // Update the table row
    const table = document.querySelector(`[data-station="${stationCode}"] table`);
    if (table) {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const nameCell = row.querySelector('.employee-name');
            if (nameCell && nameCell.textContent === driverName) {
                const cells = row.querySelectorAll('td');
                
                // Find total columns (Days, Total Stops, Total Hours, Weekly Pay)
                const totalColumnsStart = cells.length - 4;
                
                cells[totalColumnsStart].textContent = daysWorked;     // Days
                cells[totalColumnsStart + 1].textContent = totalStops; // Total Stops  
                cells[totalColumnsStart + 2].textContent = totalHours; // Total Hours
                cells[totalColumnsStart + 3].textContent = `$${newPay.toFixed(2)}`; // Weekly Pay
                
                // Update background to show it was recalculated
                cells[totalColumnsStart].style.backgroundColor = '#d4edda';
                cells[totalColumnsStart + 1].style.backgroundColor = '#d4edda';
                cells[totalColumnsStart + 2].style.backgroundColor = '#d4edda';
                cells[totalColumnsStart + 3].style.backgroundColor = '#d4edda';
            }
        });
        
        // Recalculate station totals
        recalculateStationTotals(stationCode);
    }
}

// Recalculate total payroll for a station
// Fixed station totals calculation
function recalculateStationTotals(stationCode) {
    if (!editedPayrollData[stationCode]) return;
    
    let totalPayroll = 0;
    editedPayrollData[stationCode].weeklyData.forEach(driver => {
        totalPayroll += driver.calculatedPay || 0;
    });
    
    // Update the total payroll row
    const table = document.querySelector(`[data-station="${stationCode}"] table`);
    if (table) {
        const totalRow = table.querySelector('tbody tr:last-child');
        if (totalRow) {
            const totalPayCell = totalRow.querySelector('.total-payroll');
            if (totalPayCell) {
                totalPayCell.textContent = `$${totalPayroll.toFixed(2)}`;
                totalPayCell.style.backgroundColor = '#ffc107';
                totalPayCell.style.color = '#000';
            }
        }
    }
}

// Modified function to use edited data for payroll time table export
function exportPayrollTimeTableWithEdits() {
    if (!editedPayrollData || Object.keys(editedPayrollData).length === 0) {
        showStatus('No payroll data available. Please generate summaries first.', 'error');
        return;
    }

    // Column headers matching the uploaded format
    let csvContent = "Name,Hourly Rate,Hours,OT Hours,Overtime Rate,Salary,Bonus,Gross Pay\n";
    
    let allDrivers = [];
    
    // Collect all drivers from all stations using edited data
    Object.keys(editedPayrollData).forEach(stationCode => {
        const stationData = editedPayrollData[stationCode];
        
        stationData.weeklyData.forEach(driver => {
   			const driverConfig = driverData.get(driver.driver);
    		let calculatedPay = driver.calculatedPay;
    
    		// If calculatedPay is missing or 0, recalculate it
    		if (!calculatedPay || calculatedPay === 0) {
        		if (driverConfig) {
            		const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
            		calculatedPay = payResult.totalPay;
            		// Update the stored value
            		driver.calculatedPay = calculatedPay;
        		}
    		}
            
            // Calculate total hours from edited data
            let totalHours = 0;
            stationData.dates.forEach(date => {
                const dayData = driver.dates[date];
                totalHours += dayData.hours || 0;
            });
            
            // Calculate regular and OT hours
            const regularHours = Math.min(totalHours, 40);
            const otHours = Math.max(0, totalHours - 40);
            
            // Determine if driver is salaried
            const isSalaried = driverConfig && driverConfig.paymentMethod === 'salary';
            
            let salary = 0;
            let bonus = 0;
            
            if (isSalaried) {
                salary = 500; // Fixed $500 for salaried employees
                bonus = Math.max(0, calculatedPay - 500); // Remainder as bonus
            } else {
                salary = 0;
                // For non-salaried: Bonus = Gross Pay - ((Hourly Rate  Hours) + (OT Hours  OT Rate))
                const regularPay = regularHours * 15; // $15 hourly rate
                const otPay = otHours * 22.50; // $22.50 OT rate
                bonus = Math.max(0, calculatedPay - (regularPay + otPay));
            }
            
            allDrivers.push({
                name: driver.driver,
                hourlyRate: 15,
                hours: regularHours,
                otHours: otHours,
                overtimeRate: 22.50,
                salary: salary,
                bonus: bonus,
                grossPay: calculatedPay
            });
        });
    });
    
    // Sort drivers alphabetically by name
    allDrivers.sort((a, b) => a.name.localeCompare(b.name));
    
    // Add driver data to CSV
    allDrivers.forEach(driver => {
        csvContent += `"${driver.name}",${driver.hourlyRate},${driver.hours.toFixed(2)},${driver.otHours.toFixed(2)},${driver.overtimeRate},${driver.salary.toFixed(2)},${driver.bonus.toFixed(2)},${driver.grossPay.toFixed(2)}\n`;
    });
    
    // Add totals row
    const totalRegularHours = allDrivers.reduce((sum, d) => sum + d.hours, 0);
    const totalOTHours = allDrivers.reduce((sum, d) => sum + d.otHours, 0);
    const totalSalary = allDrivers.reduce((sum, d) => sum + d.salary, 0);
    const totalBonus = allDrivers.reduce((sum, d) => sum + d.bonus, 0);
    const totalGrossPay = allDrivers.reduce((sum, d) => sum + d.grossPay, 0);
    
    csvContent += `"TOTALS",,${totalRegularHours.toFixed(2)},${totalOTHours.toFixed(2)},,${totalSalary.toFixed(2)},${totalBonus.toFixed(2)},${totalGrossPay.toFixed(2)}\n`;
    
    // Download the file
    downloadExcelFile(csvContent, 'Payroll_Time_Table');
    
    showStatus(`Payroll Time Table exported successfully! ${allDrivers.length} drivers included.`, 'success');
}

// Modified download functions to use edited data
function downloadStationWithEditedData(stationCode) {
    if (!editedPayrollData[stationCode]) {
        showStatus('No edited data available for this station', 'error');
        return;
    }
    
    const stationData = editedPayrollData[stationCode];
    
    // Ensure all drivers have calculated pay from edited data
    const enhancedWeeklyData = stationData.weeklyData.map(driver => {
        let calculatedPay = driver.calculatedPay;
        
        // If calculatedPay is missing or 0, recalculate it
        if (!calculatedPay || calculatedPay === 0) {
            const driverConfig = driverData.get(driver.driver);
            if (driverConfig) {
                const payResult = calculateDriverPay(driver.dates, driverConfig, stationData.dates);
                calculatedPay = payResult.totalPay;
                // Update the stored value
                driver.calculatedPay = calculatedPay;
            }
        }
        
        return {
            ...driver,
            calculatedPay: calculatedPay || 0
        };
    });
    
    generateStationHTMLWithPay(stationCode, stationData.dates, enhancedWeeklyData, stationData);
}

// Export station to Excel with edited data
function exportStationToExcelWithEditedData(stationCode) {
    if (!editedPayrollData[stationCode]) {
        showStatus('No edited data available for this station', 'error');
        return;
    }
    
    const stationData = editedPayrollData[stationCode];
    
    let csvContent = "Driver Name,";
    
    // Add date headers
    stationData.dates.forEach(date => {
        csvContent += `"${date} Stops","${date} Hours",`;
    });
    csvContent += "Days Worked,Total Stops,Total Hours,Weekly Pay,Payment Method\n";
    
    // Add driver data using edited values
    stationData.weeklyData.forEach(driver => {
        const driverConfig = driverData.get(driver.driver);
        let calculatedPay = driver.calculatedPay || 0;
        let paymentMethod = 'Not Configured';
        
        if (driverConfig) {
            paymentMethod = formatPaymentMethod(driverConfig.paymentMethod);
        }
        
        csvContent += `"${driver.driver}",`;
        
        // Add daily data using edited values
        let totalStops = 0, totalHours = 0, daysWorked = 0;
        stationData.dates.forEach(date => {
            const dayData = driver.dates[date];
            if (dayData.totalStops > 0 || dayData.hours > 0) {
                csvContent += `${dayData.totalStops},${dayData.hours},`;
                totalStops += dayData.totalStops;
                totalHours += dayData.hours;
                daysWorked++;
            } else {
                csvContent += "0,0,";
            }
        });
        
        csvContent += `${daysWorked},${totalStops},${totalHours},${calculatedPay.toFixed(2)},"${paymentMethod}"\n`;
    });
    
    // Add total row
    let totalPayroll = 0;
    let totalDrivers = stationData.weeklyData.length;
    stationData.weeklyData.forEach(driver => {
        totalPayroll += driver.calculatedPay || 0;
    });
    
    csvContent += `"TOTAL PAYROLL (${totalDrivers} drivers)",`;
    // Add empty cells for daily data
    stationData.dates.forEach(() => {
        csvContent += ",,";
    });
    csvContent += `,,,$${totalPayroll.toFixed(2)},\n`;
    
    downloadExcelFile(csvContent, `${stationCode.replace(/\//g, '_')}_Payroll_Detail_Edited`);
}
// Update the main export functions to use edited data
function exportAllStationsToExcelWithEdits() {
    if (!editedPayrollData || Object.keys(editedPayrollData).length === 0) {
        showStatus('No payroll data available. Please generate summaries first.', 'error');
        return;
    }

    let csvContent = "Station,Driver Name,Days Worked,Total Stops,Total Hours,Weekly Pay,Payment Method,Date Range\n";
    
    Object.keys(editedPayrollData).forEach(stationCode => {
        const stationData = editedPayrollData[stationCode];
        const dateRange = `${stationData.dates[0]} to ${stationData.dates[stationData.dates.length - 1]}`;
        
        stationData.weeklyData.forEach(driver => {
            const driverConfig = driverData.get(driver.driver);
            let calculatedPay = driver.calculatedPay || 0;
            let paymentMethod = 'Not Configured';
            
            if (driverConfig) {
                paymentMethod = formatPaymentMethod(driverConfig.paymentMethod);
            }
            
            // Calculate totals from edited data
            let totalStops = 0, totalHours = 0, daysWorked = 0;
            stationData.dates.forEach(date => {
                const dayData = driver.dates[date];
                if (dayData.totalStops > 0 || dayData.hours > 0) {
                    totalStops += dayData.totalStops;
                    totalHours += dayData.hours;
                    daysWorked++;
                }
            });
            
            csvContent += `"${stationCode}","${driver.driver}",${daysWorked},${totalStops},${totalHours},${calculatedPay.toFixed(2)},"${paymentMethod}","${dateRange}"\n`;
        });
    });
    
    downloadExcelFile(csvContent, 'Payroll_Summary_All_Stations_Edited');
}
            
    </script>
</body>
</html>
